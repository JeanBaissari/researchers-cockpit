---
description: Script conventions - CLI patterns with click, project root discovery, error handling, structure
globs: scripts/**/*.py
alwaysApply: false
---

# Script Conventions

## Purpose
Define CLI script patterns using click library, project root discovery, error handling, script structure, and user feedback standards.

## Script Structure

### Standard Script Template

```python
#!/usr/bin/env python3
"""
Script description.

Usage examples and common use cases.
"""

import sys
from pathlib import Path

# Add project root to path
from lib.paths import get_project_root, ProjectRootNotFoundError
from lib.logging.config import configure_logging
from lib.logging.loggers import get_logger

# Configure logging
configure_logging()
logger = get_logger(__name__)


def main():
    """Main script entry point."""
    try:
        # Script logic here
        pass
    except ProjectRootNotFoundError as e:
        logger.error(f"Project root not found: {e}")
        sys.exit(1)
    except Exception as e:
        logger.error(f"Script failed: {e}", exc_info=True)
        sys.exit(1)


if __name__ == '__main__':
    main()

# ✅ GOOD - Complete script structure
# ❌ BAD - Missing shebang, error handling, or project root discovery
```

### Required Components

```python
# ✅ GOOD - All required components
#!/usr/bin/env python3          # Shebang
"""Script docstring."""          # Description
from lib.paths import get_project_root  # Project root discovery
from lib.logging.config import configure_logging  # Logging setup
def main(): pass                 # Main function
if __name__ == '__main__': main()  # Entry point

# ❌ BAD - Missing components
# No shebang
# No docstring
import sys  # No project root discovery!
def main(): pass  # No error handling!
```

## CLI Patterns with Click

### Basic Click Structure

```python
# ✅ GOOD - Click CLI pattern
import click
from lib.paths import get_project_root
from lib.logging.config import configure_logging

@click.command()
@click.option('--strategy', required=True, help='Strategy name')
@click.option('--start-date', help='Start date (YYYY-MM-DD)')
@click.option('--end-date', help='End date (YYYY-MM-DD)')
def run_backtest(strategy, start_date, end_date):
    """Run a backtest for a strategy."""
    configure_logging()
    root = get_project_root()
    # ... backtest logic

if __name__ == '__main__':
    run_backtest()

# ❌ BAD - Manual argument parsing
import sys
if len(sys.argv) < 2:
    print("Usage: script.py <strategy>")
    sys.exit(1)
strategy = sys.argv[1]
# Use click instead!
```

### Click Options and Arguments

```python
# ✅ GOOD - Well-defined options
@click.command()
@click.argument('strategy')
@click.option('--start-date', default=None, help='Backtest start date')
@click.option('--end-date', default=None, help='Backtest end date')
@click.option('--capital', type=float, default=100000, help='Initial capital')
@click.flag('--verbose', help='Enable verbose logging')
def run_backtest(strategy, start_date, end_date, capital, verbose):
    """Run backtest with options."""
    if verbose:
        configure_logging(level='DEBUG')
    # ... logic

# ❌ BAD - Positional arguments only
def run_backtest(strategy, start_date, end_date):
    # No help text, no validation, no defaults!
    pass
```

## Project Root Discovery

### Use _find_project_root() Pattern

```python
# ✅ GOOD - Use lib/paths.py
from lib.paths import get_project_root, ProjectRootNotFoundError

try:
    root = get_project_root()
    config_path = root / 'config' / 'settings.yaml'
except ProjectRootNotFoundError as e:
    logger.error(f"Cannot find project root: {e}")
    sys.exit(1)

# ❌ BAD - Hardcoded or relative paths
root = Path('/home/user/project')  # Hardcoded!
# or
root = Path(__file__).parent.parent  # Fragile relative path!
```

### Error Handling for Root Discovery

```python
# ✅ GOOD - Handle root discovery errors
try:
    root = get_project_root()
except ProjectRootNotFoundError as e:
    click.echo(f"Error: {e}", err=True)
    click.echo("Set PROJECT_ROOT environment variable to override.")
    sys.exit(1)

# ❌ BAD - Let exception propagate
root = get_project_root()  # May crash with unclear error!
```

## Error Handling and User Feedback

### Clear Error Messages

```python
# ✅ GOOD - User-friendly error messages
try:
    strategy_path = resolve_strategy_path(strategy_name)
except FileNotFoundError:
    click.echo(f"Error: Strategy '{strategy_name}' not found.", err=True)
    click.echo(f"Searched in: {get_strategies_dir()}", err=True)
    click.echo("Create strategy using: scripts/create_strategy.py", err=True)
    sys.exit(1)

# ❌ BAD - Technical error messages
try:
    strategy_path = resolve_strategy_path(strategy_name)
except FileNotFoundError as e:
    click.echo(f"Error: {e}", err=True)  # Too technical!
    sys.exit(1)
```

### Exit Codes

```python
# ✅ GOOD - Appropriate exit codes
if validation_failed:
    logger.error("Validation failed")
    sys.exit(1)  # Error exit code

# ❌ BAD - Wrong exit codes
if error:
    sys.exit(0)  # Wrong exit code for error!
```

## Enforcement

- **Structure Check**: Verify shebang, docstring, main() function
- **Click Usage**: Ensure CLI uses click library
- **Root Discovery**: Check use of get_project_root()
- **Error Handling**: Verify user-friendly error messages
- **Exit Codes**: Check appropriate exit codes

## Related Agents

- `.claude/agents/maintainer.md` - Script maintenance
- `.claude/agents/data-ingestor.md` - Data scripts
- `.claude/agents/backtest_runner.md` - Backtest scripts

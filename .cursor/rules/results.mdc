---
description: Results management - result directory structure, timestamp naming, symlink management, file organization
globs: results/**/*
alwaysApply: false
---

# Results Management Patterns

## Purpose
Define patterns for managing backtest results in `results/`, including directory structure, timestamp naming conventions, symlink management, and result file organization.

## Result Directory Structure

### Standard Directory Layout
Results organized in timestamped directories with symlinks.

```
# ✅ GOOD - Standard result structure
results/{strategy_name}/
├── backtest_20241220_143022/
│   ├── returns.csv              # Daily/minute returns
│   ├── positions.csv             # Position history
│   ├── transactions.csv          # All trades
│   ├── metrics.json              # Performance metrics
│   ├── parameters_used.yaml      # Strategy config snapshot
│   └── equity_curve.png          # Performance visualization
├── optimization_20241221_091500/
│   ├── grid_results.csv
│   ├── best_params.yaml
│   └── overfit_score.json
└── latest -> backtest_20241220_143022/  # Symlink to latest

# ❌ BAD - Non-standard structure
results/{strategy_name}/
├── results_1/  # No timestamp!
├── my_results/  # Inconsistent naming!
└── latest/  # Directory, not symlink!
```

## Timestamp Naming Conventions

### Use Standard Timestamp Format
Result directories use format: `{result_type}_YYYYMMDD_HHMMSS`.

```python
# ✅ GOOD - Standard timestamp format
results/btc_sma_cross/
├── backtest_20241220_143022/      # backtest_YYYYMMDD_HHMMSS
├── optimization_20241221_091500/  # optimization_YYYYMMDD_HHMMSS
├── walkforward_20241222_160033/   # walkforward_YYYYMMDD_HHMMSS
└── latest -> backtest_20241220_143022/

# ❌ BAD - Non-standard naming
results/btc_sma_cross/
├── backtest_2024-12-20/  # Wrong format!
├── results_1/  # No timestamp!
└── latest_run/  # Non-standard!
```

## Symlink Management

### Use Latest Symlink
Always create/update `latest/` symlink to most recent results.

```python
# ✅ GOOD - Symlink automatically created by save_results()
from lib.backtest import save_results

result_dir = save_results(
    strategy_name='btc_sma_cross',
    perf=perf,
    params=params,
    trading_calendar=calendar
)
# Creates: results/btc_sma_cross/backtest_20241220_143022/
# Updates: results/btc_sma_cross/latest/ -> symlink

# ❌ BAD - Manual symlink creation
import os
os.symlink(result_dir, 'latest')  # Don't create manually!
```

### Symlink Usage

```python
# ✅ GOOD - Access latest results via symlink
from pathlib import Path
import json

latest_dir = Path('results/btc_sma_cross/latest')
metrics_file = latest_dir / 'metrics.json'

with open(metrics_file) as f:
    metrics = json.load(f)

# ❌ BAD - Hardcode result directory
metrics_file = Path('results/btc_sma_cross/backtest_20241220_143022/metrics.json')
# Hardcoded timestamp - will break!
```

## Result File Organization

### Standard Result Files
Each result directory contains standard files.

```python
# ✅ GOOD - Standard result files
result_dir/
├── returns.csv              # Required: Daily/minute returns
├── positions.csv            # Required: Position history
├── transactions.csv         # Required: All trades
├── metrics.json             # Required: Performance metrics
├── parameters_used.yaml     # Required: Strategy config snapshot
└── equity_curve.png         # Optional: Visualization (if matplotlib available)

# ❌ BAD - Missing required files
result_dir/
└── results.txt  # Non-standard file!
```

## Result Type Prefixes

### Use Appropriate Result Type
Use correct prefix for result type.

```python
# ✅ GOOD - Appropriate result type
save_results(..., result_type='backtest')      # backtest_YYYYMMDD_HHMMSS
save_results(..., result_type='optimization') # optimization_YYYYMMDD_HHMMSS
save_results(..., result_type='walkforward')  # walkforward_YYYYMMDD_HHMMSS

# ❌ BAD - Wrong result type
save_results(..., result_type='backtest')
# But results are from optimization!
```

## Metrics File

### Standard Metrics JSON Structure
Metrics file must follow standard structure.

```json
# ✅ GOOD - Standard metrics.json structure
{
  "total_return": 0.15,
  "sharpe_ratio": 1.25,
  "sortino_ratio": 1.45,
  "max_drawdown": -0.08,
  "win_rate": 0.55,
  "trade_count": 120,
  ...
}

# ❌ BAD - Non-standard metrics
{
  "returns": 0.15,
  "sharpe": 1.25
  # Missing standard metrics!
}
```

## Parameters Snapshot

### Save Parameters Used
Always save parameters snapshot with results.

```python
# ✅ GOOD - Parameters automatically saved
result_dir = save_results(
    strategy_name='btc_sma_cross',
    perf=perf,
    params=params,  # Parameters saved to parameters_used.yaml
    trading_calendar=calendar
)

# ❌ BAD - Don't save parameters
# Missing parameters_used.yaml - can't reproduce results!
```

## Enforcement

- **Directory Structure**: Verify standard structure followed
- **Timestamp Format**: Check timestamp format correct
- **Symlink Management**: Ensure latest symlink created
- **File Organization**: Verify all required files present

## Related Agents

- `.claude/agents/backtest-runner.md` - Result saving
- `.claude/agents/report-generator.md` - Result access
- `lib/backtest/results.py` - Result saving implementation

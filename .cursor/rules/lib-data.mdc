---
description: Data processing utilities - aggregation, filtering, normalization, forex data handling
globs: lib/data/**/*.py
alwaysApply: false
---

# Data Processing Utilities Patterns

## Purpose
Define patterns for data processing using `lib/data/` modules, including aggregation, filtering, normalization, and forex-specific data handling.

## Data Aggregation

### Use aggregate_ohlcv() Function
Always use `lib.data.aggregate_ohlcv()` for timeframe aggregation.

```python
# ✅ GOOD - Use aggregate_ohlcv()
from lib.data import aggregate_ohlcv

# Aggregate 1-minute to 5-minute
df_5m = aggregate_ohlcv(df_1m, target_timeframe='5m')

# Aggregate to hourly
df_1h = aggregate_ohlcv(df_1m, target_timeframe='1h')

# Aggregate to daily
df_daily = aggregate_ohlcv(df_1m, target_timeframe='daily')

# ❌ BAD - Manual aggregation
df_5m = df_1m.resample('5T').agg({
    'open': 'first',
    'high': 'max',
    # ... incomplete aggregation rules!
})
```

### Aggregation Timeframes

```python
# ✅ GOOD - Use valid timeframe strings
from lib.data import aggregate_ohlcv

# Supported timeframes
df_5m = aggregate_ohlcv(df_1m, '5m')      # 5 minutes
df_15m = aggregate_ohlcv(df_1m, '15m')    # 15 minutes
df_30m = aggregate_ohlcv(df_1m, '30m')    # 30 minutes
df_1h = aggregate_ohlcv(df_1m, '1h')       # 1 hour
df_4h = aggregate_ohlcv(df_1m, '4h')      # 4 hours
df_daily = aggregate_ohlcv(df_1m, 'daily') # Daily

# ❌ BAD - Invalid timeframe
df_agg = aggregate_ohlcv(df_1m, '2h')  # Not supported!
```

## Data Normalization

### Use normalize_to_utc() Function
Always normalize timestamps to UTC using `lib.data.normalization.normalize_to_utc()`.

```python
# ✅ GOOD - Normalize to UTC
from lib.data.normalization import normalize_to_utc

# Normalize timestamp
df.index = df.index.map(normalize_to_utc)

# Or normalize single timestamp
timestamp = normalize_to_utc('2024-01-01 10:00:00')

# ❌ BAD - Keep local timezone
df.index = pd.to_datetime(df.index)  # May have timezone issues!
```

### Timezone Normalization Patterns

```python
# ✅ GOOD - Normalize all timestamps to UTC
from lib.data.normalization import normalize_to_utc

# Normalize DataFrame index
if df.index.tz is not None:
    df.index = df.index.map(normalize_to_utc)
else:
    df.index = pd.to_datetime(df.index).tz_localize('UTC')

# Normalize before aggregation
df_normalized = df.copy()
df_normalized.index = df_normalized.index.map(normalize_to_utc)
df_agg = aggregate_ohlcv(df_normalized, '1h')

# ❌ BAD - Mixed timezones
df1.index = df1.index.tz_localize('America/New_York')
df2.index = df2.index.tz_localize('UTC')
# Timezone mismatch!
```

## Forex Data Handling

### Use Forex-Specific Filters
Use forex-specific filters for forex data processing.

```python
# ✅ GOOD - Use forex filters
from lib.data.filters import (
    filter_forex_presession_bars,
    consolidate_forex_sunday_to_friday,
    filter_to_calendar_sessions
)

# Filter pre-session bars
df_filtered = filter_forex_presession_bars(df)

# Consolidate Sunday to Friday
df_consolidated = consolidate_forex_sunday_to_friday(df, calendar_obj)

# Filter to calendar sessions
df_sessions = filter_to_calendar_sessions(df, calendar_obj)

# ❌ BAD - Don't filter forex data
df_forex = load_forex_data()  # Missing forex-specific filtering!
```

### Forex Sunday Consolidation

```python
# ✅ GOOD - Consolidate forex Sunday bars
from lib.data.filters import consolidate_forex_sunday_to_friday

# Forex data often has Sunday bars that should be consolidated
df_consolidated = consolidate_forex_sunday_to_friday(
    df=df,
    calendar_obj=forex_calendar,
    show_progress=False,
    sid=0
)

# ❌ BAD - Keep Sunday bars separate
# Sunday bars should be consolidated to Friday!
```

## Data Filtering

### Use Calendar Session Filtering
Filter data to calendar trading sessions.

```python
# ✅ GOOD - Filter to calendar sessions
from lib.data.filters import filter_to_calendar_sessions

# Filter to trading sessions only
df_filtered = filter_to_calendar_sessions(
    df=df,
    calendar_obj=trading_calendar,
    show_progress=False,
    sid=0
)

# ❌ BAD - Include non-trading hours
# Data includes weekends/holidays that shouldn't be traded!
```

### Gap Filling

```python
# ✅ GOOD - Fill data gaps appropriately
from lib.data.normalization import fill_data_gaps

# Fill gaps using forward fill
df_filled = fill_data_gaps(
    df=df,
    calendar=trading_calendar,
    method='ffill',
    max_gap_days=5
)

# ❌ BAD - Leave gaps unfilled
# Gaps in data can cause backtest issues!
```

## Data Processing Pipeline

### Complete Data Processing Pipeline
Follow complete pipeline: normalize → filter → aggregate.

```python
# ✅ GOOD - Complete processing pipeline
from lib.data.normalization import normalize_to_utc
from lib.data.filters import filter_to_calendar_sessions
from lib.data import aggregate_ohlcv

# 1. Normalize timestamps
df.index = df.index.map(normalize_to_utc)

# 2. Filter to trading sessions (if needed)
df = filter_to_calendar_sessions(df, calendar_obj)

# 3. Aggregate to target timeframe
df_agg = aggregate_ohlcv(df, target_timeframe='1h')

# ❌ BAD - Skip processing steps
df_agg = aggregate_ohlcv(df, '1h')  # Missing normalization/filtering!
```

## Enforcement

- **Code Review**: Verify use of data processing functions
- **Normalization**: Check timestamps normalized to UTC
- **Forex Handling**: Verify forex-specific filters used
- **Pipeline Compliance**: Ensure complete processing pipeline

## Related Agents

- `.claude/agents/data-explorer.md` - Data processing
- `.claude/agents/data-ingestor.md` - Data normalization
- `lib/data/` - Data processing module documentation

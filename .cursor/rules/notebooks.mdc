---
description: Jupyter notebook standards - cell organization, path resolution, imports, visualization
globs: notebooks/**/*.ipynb
alwaysApply: false
---

# Jupyter Notebook Standards

## Purpose
Define notebook cell organization, path resolution patterns, import conventions, result visualization, and documentation standards for research notebooks.

## Cell Organization

### Standard Notebook Structure

```python
# ✅ GOOD - Organized notebook structure
# Cell 1: Setup and Imports
import sys
from pathlib import Path
from lib.paths import get_project_root
from lib.config import load_settings
# ... other imports

# Cell 2: Configuration
root = get_project_root()
settings = load_settings()
strategy_name = 'btc_sma_cross'

# Cell 3: Data Loading
# Load data, bundles, etc.

# Cell 4: Execution
# Run backtest, optimization, etc.

# Cell 5: Results and Visualization
# Display results, plots, metrics

# ❌ BAD - Disorganized cells
# Cell 1: Random imports and execution mixed
import pandas as pd
run_backtest()  # No setup!
# Cell 2: More random code
# No clear structure!
```

### Cell Order Pattern

1. **Setup Cell**: Imports, project root discovery
2. **Configuration Cell**: Load configs, set parameters
3. **Data Cell**: Load data, validate bundles
4. **Execution Cell**: Run operations (backtest, optimization)
5. **Results Cell**: Display results, create visualizations
6. **Documentation Cell**: Markdown explanations

```python
# ✅ GOOD - Clear cell sequence
# [Markdown] # Backtest Analysis: BTC SMA Cross
# [Code] # Setup
# [Code] # Configuration  
# [Code] # Data Loading
# [Code] # Execution
# [Code] # Results
# [Markdown] # Conclusions

# ❌ BAD - Mixed or missing cells
# [Code] # Random execution
# [Code] # More random code
# No markdown, no organization!
```

## Path Resolution

### Project Root Discovery in Notebooks

```python
# ✅ GOOD - Use get_project_root() in first cell
from lib.paths import get_project_root, ProjectRootNotFoundError

try:
    root = get_project_root()
    print(f"Project root: {root}")
except ProjectRootNotFoundError as e:
    print(f"Error: {e}")
    # Handle error

# ❌ BAD - Hardcoded or relative paths
root = Path('/home/user/project')  # Hardcoded!
# or
root = Path('../../')  # Fragile relative path!
```

### Path Setup Pattern

```python
# ✅ GOOD - Standard path setup cell
import sys
from lib.paths import get_project_root

root = get_project_root()
if str(root) not in sys.path:
    sys.path.insert(0, str(root))

# ❌ BAD - No path setup
# Just start using paths - may fail!
```

## Import Patterns

### Notebook Imports

```python
# ✅ GOOD - Organized imports
# Standard library
import sys
from pathlib import Path

# Third-party
import pandas as pd
import matplotlib.pyplot as plt

# Project imports (after path setup)
from lib.config import load_settings
from lib.backtest import run_backtest

# ❌ BAD - Mixed or missing imports
import pandas as pd
from lib.config import load_settings
import sys
# No organization!
```

### Import After Path Setup

```python
# ✅ GOOD - Setup path before project imports
root = get_project_root()
sys.path.insert(0, str(root))
from lib.config import load_settings

# ❌ BAD - Import before path setup
from lib.config import load_settings  # May fail!
```

## Result Visualization

### Plot Organization

```python
# ✅ GOOD - Organized plotting
import matplotlib.pyplot as plt
from lib.plots import plot_equity_curve

fig, axes = plt.subplots(2, 1, figsize=(12, 8))
plot_equity_curve(performance, ax=axes[0])
plot_drawdown(performance, ax=axes[1])
plt.tight_layout()
plt.show()

# ❌ BAD - Disorganized plots
plt.plot(data)  # No labels, no organization!
plt.show()
```

### Save Plots

```python
# ✅ GOOD - Save plots with proper paths
from lib.paths import get_results_dir
from lib.utils import timestamp_dir

result_dir = timestamp_dir(get_results_dir() / 'btc_sma_cross', 'analysis')
plt.savefig(result_dir / 'equity_curve.png', dpi=300)

# ❌ BAD - No saving or wrong location
plt.show()  # Plot not saved!
plt.savefig('plot.png')  # Wrong location!
```

## Documentation in Notebooks

### Markdown Cells and Comments

```markdown
# ✅ GOOD - Documented notebook
# # Backtest Analysis: BTC SMA Cross
# ## Hypothesis
# Bitcoin trends persist for more than 20 days.

# ❌ BAD - No documentation
# Just code cells - no explanation!
```

### Inline Comments

```python
# ✅ GOOD - Clear inline documentation
# Load strategy parameters
params = load_strategy_params('btc_sma_cross')

# Run backtest
results = run_backtest('btc_sma_cross', '2023-01-01', '2024-06-01')

# ❌ BAD - No comments
params = load_strategy_params('btc_sma_cross')
results = run_backtest('btc_sma_cross', '2023-01-01', '2024-06-01')
```

## Enforcement

- **Cell Organization**: Verify standard structure
- **Path Resolution**: Check use of get_project_root()
- **Import Patterns**: Verify organized imports
- **Documentation**: Check markdown cells and comments

## Related Agents

- `.claude/agents/analyst.md` - Notebook analysis patterns
- `.claude/agents/backtest_runner.md` - Backtest notebooks

---
description: Logging module patterns - configure_logging, specialized loggers, LogContext, formatters
globs: lib/logging/**/*.py
alwaysApply: false
---

# Logging Module Patterns

## Purpose
Define patterns for using `lib/logging/` modules, including configure_logging, specialized loggers, LogContext, and formatter configuration.

## Logging Configuration

### Use configure_logging() Function
Always use `lib.logging.config.configure_logging()` to configure logging.

```python
# ✅ GOOD - Use configure_logging()
from lib.logging.config import configure_logging

# Configure at script/module entry
configure_logging(
    level='INFO',
    console=True,
    file=True,
    structured=True
)

# ❌ BAD - Basic logging configuration
import logging
logging.basicConfig(level=logging.INFO)  # Don't use basic logging!
```

### Configure Logging with Context

```python
# ✅ GOOD - Configure with context
from lib.logging.config import configure_logging

configure_logging(
    strategy_name='btc_sma_cross',
    run_id='20241220_143000',
    level='INFO',
    asset_type='crypto',
    bundle_name='yahoo_crypto_daily',
    timeframe='daily'
)

# All logs will include this context automatically

# ❌ BAD - Configure without context
configure_logging(level='INFO')  # Missing context!
```

## Specialized Loggers

### Use Pre-Configured Loggers
Use specialized loggers from `lib.logging.loggers` for different operations.

```python
# ✅ GOOD - Use specialized loggers
from lib.logging.loggers import (
    data_logger,
    strategy_logger,
    backtest_logger,
    metrics_logger,
    validation_logger
)

# Data operations
data_logger.info("Ingesting bundle: yahoo_crypto_daily")

# Strategy operations
strategy_logger.info("Running backtest: btc_sma_cross")

# Backtest operations
backtest_logger.info("Backtest started")

# Metrics operations
metrics_logger.info("Calculating performance metrics")

# Validation operations
validation_logger.info("Validating data before ingestion")

# ❌ BAD - Generic logger for all purposes
from lib.logging.config import get_logger
logger = get_logger(__name__)
logger.info("Data operation")  # Should use data_logger!
```

## LogContext Usage

### Use LogContext for Operation Scoping
Use `LogContext` to add context to all logs within a block.

```python
# ✅ GOOD - Use LogContext
from lib.logging.context import LogContext

with LogContext(
    phase='backtest',
    strategy='btc_sma_cross',
    run_id='20241220_143000',
    asset_type='crypto',
    bundle_name='yahoo_crypto_daily',
    timeframe='daily'
):
    logger.info("Starting backtest")
    # All logs in this block include full context
    logger.info("Loading parameters")
    logger.info("Backtest completed")
    # Context automatically cleared on exit

# ❌ BAD - Manual context management
context = {'strategy': 'btc_sma_cross'}
logger.info("Starting backtest", extra=context)
# Manual cleanup required - error-prone!
```

## Context Value Management

### Use Context Value Functions
Use context value functions for dynamic context updates.

```python
# ✅ GOOD - Use context value functions
from lib.logging.context import (
    set_context_value,
    get_context_value,
    clear_context_value
)

# Set context value dynamically
set_context_value('progress', '50%')
logger.info("Progress update")  # Includes progress in log

# Get context value
current_strategy = get_context_value('strategy')

# Clear context value
clear_context_value('progress')

# ❌ BAD - Manual context dictionary
_context = {'strategy': 'btc_sma_cross'}
# Don't manage context manually!
```

## Formatter Configuration

### Use Project Formatters
Formatters are automatically configured - don't override.

```python
# ✅ GOOD - Formatters configured automatically
from lib.logging.config import configure_logging

configure_logging()
logger.info("Message")  # Uses StructuredFormatter for files, ConsoleFormatter for console

# ❌ BAD - Custom formatter configuration
import logging
formatter = logging.Formatter('%(message)s')
handler.setFormatter(formatter)  # Don't override project formatters!
```

## Logging Utility Functions

### Use log_exception() for Exceptions
Use `log_exception()` for structured exception logging.

```python
# ✅ GOOD - Use log_exception()
from lib.logging.utils import log_exception
from lib.logging.error_codes import ErrorCode

try:
    risky_operation()
except ValueError as e:
    log_exception(
        logger,
        "Failed to process data",
        exc=e,
        error_code=ErrorCode.VALIDATION_ERROR,
        data_source="yahoo"
    )

# ❌ BAD - Basic exception logging
try:
    risky_operation()
except Exception as e:
    logger.error(f"Error: {e}")  # Missing structure and context!
```

### Use log_with_context() for Additional Fields
Use `log_with_context()` for logs with extra context fields.

```python
# ✅ GOOD - Use log_with_context()
from lib.logging.utils import log_with_context
import logging

log_with_context(
    logger,
    logging.INFO,
    "Bundle ingestion started",
    bundle_name="btc_1d",
    record_count=1000,
    source="yahoo"
)

# ❌ BAD - Manual extra fields
logger.info("Bundle ingestion started", extra={'bundle_name': 'btc_1d'})
# Use log_with_context for consistency!
```

## Logging Best Practices

### Configure Logging Early
Configure logging at the start of scripts/modules.

```python
# ✅ GOOD - Configure at script entry
from lib.logging.config import configure_logging

if __name__ == '__main__':
    configure_logging(level='INFO')
    # ... rest of script

# ❌ BAD - Configure late in script
# ... script logic ...
configure_logging()  # Too late!
```

## Enforcement

- **Code Review**: Verify logging configuration and logger usage
- **Specialized Loggers**: Check appropriate logger used for operation type
- **Context Usage**: Ensure LogContext used for operations
- **Formatter Compliance**: Verify no custom formatter overrides

## Related Agents

- `.claude/agents/maintainer.md` - Logging patterns
- `.claude/agents/codebase-architect.md` - Logging infrastructure
- `lib/logging/` - Logging module documentation

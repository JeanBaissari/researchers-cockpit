---
description: Visualization patterns - plot_equity_curve, plot_drawdown, plot saving, format options
globs: lib/plots/**/*.py
alwaysApply: false
---

# Visualization Patterns

## Purpose
Define patterns for creating visualizations using `lib/plots/` modules, including plot_equity_curve, plot_drawdown, plot saving conventions, and format options.

## Equity Curve Plotting

### Use plot_equity_curve() Function
Always use `lib.plots.plot_equity_curve()` for equity curve visualization.

```python
# ✅ GOOD - Use plot_equity_curve()
from lib.plots import plot_equity_curve

plot_equity_curve(
    returns=returns_series,
    portfolio_value=portfolio_value_series,  # Optional
    save_path=Path('results/equity_curve.png'),
    title='Strategy Equity Curve'
)

# ❌ BAD - Manual plotting
import matplotlib.pyplot as plt
plt.plot(returns.cumprod())  # Incomplete plot!
```

### Equity Curve Parameters

```python
# ✅ GOOD - Complete parameter specification
from lib.plots import plot_equity_curve
from pathlib import Path

plot_equity_curve(
    returns=returns_series,              # Required: returns series
    portfolio_value=portfolio_value,     # Optional: portfolio values
    save_path=Path('plots/equity.png'),  # Optional: save path
    title='BTC SMA Cross - Equity Curve'  # Optional: plot title
)

# ❌ BAD - Missing required parameters
plot_equity_curve()  # Missing returns!
```

## Drawdown Plotting

### Use plot_drawdown() Function
Use `lib.plots.plot_drawdown()` for drawdown visualization.

```python
# ✅ GOOD - Use plot_drawdown()
from lib.plots import plot_drawdown

plot_drawdown(
    returns=returns_series,
    save_path=Path('results/drawdown.png'),
    title='Strategy Drawdown Chart'
)

# ❌ BAD - Manual drawdown calculation
cumulative = (1 + returns).cumprod()
drawdown = (cumulative - cumulative.cummax()) / cumulative.cummax()
plt.plot(drawdown)  # Incomplete plot!
```

## Plot Saving Conventions

### Save Plots to Results Directory
Always save plots to results directory with standard naming.

```python
# ✅ GOOD - Save to results directory
from lib.plots import plot_equity_curve, plot_drawdown
from pathlib import Path

result_dir = Path('results/btc_sma_cross/backtest_20241220_143000')
result_dir.mkdir(parents=True, exist_ok=True)

# Save plots with standard names
plot_equity_curve(
    returns=returns,
    save_path=result_dir / 'equity_curve.png'
)

plot_drawdown(
    returns=returns,
    save_path=result_dir / 'drawdown.png'
)

# ❌ BAD - Save to non-standard location
plot_equity_curve(returns, save_path=Path('my_plot.png'))  # Non-standard!
```

## Plot Format Options

### Use Standard Plot Formats
Save plots in standard formats (PNG, SVG, PDF).

```python
# ✅ GOOD - Use standard formats
from lib.plots import plot_equity_curve
from pathlib import Path

# PNG (default, for reports)
plot_equity_curve(returns, save_path=Path('equity_curve.png'))

# SVG (vector, for presentations)
plot_equity_curve(returns, save_path=Path('equity_curve.svg'))

# PDF (for documents)
plot_equity_curve(returns, save_path=Path('equity_curve.pdf'))

# ❌ BAD - Non-standard formats
plot_equity_curve(returns, save_path=Path('equity_curve.jpg'))  # Use PNG!
```

## Plot All Function

### Use plot_all() for Complete Visualization
Use `plot_all()` to generate all standard plots at once.

```python
# ✅ GOOD - Use plot_all()
from lib.plots import plot_all
from pathlib import Path

plot_all(
    returns=returns_series,
    save_dir=Path('results/btc_sma_cross/plots'),
    portfolio_value=portfolio_value,
    transactions=transactions_df,
    strategy_name='BTC SMA Cross'
)

# Generates:
# - equity_curve.png
# - drawdown.png
# - monthly_returns.png
# - rolling_metrics.png
# - trade_analysis.png (if transactions provided)

# ❌ BAD - Generate plots individually
plot_equity_curve(...)
plot_drawdown(...)
# ... missing other plots!
```

## Plot Organization

### Organize Plots by Strategy
Organize plots in strategy-specific directories.

```python
# ✅ GOOD - Organize by strategy
from lib.plots import plot_all
from pathlib import Path

strategy_name = 'btc_sma_cross'
result_dir = Path(f'results/{strategy_name}/backtest_20241220_143000')

plot_all(
    returns=returns,
    save_dir=result_dir,
    portfolio_value=portfolio_value,
    transactions=transactions,
    strategy_name=strategy_name
)

# ❌ BAD - Save all plots to root
plot_all(returns, save_dir=Path('plots'))  # No organization!
```

## Plot Quality Settings

### Use High DPI for Plots
Plots automatically use high DPI (150) for quality.

```python
# ✅ GOOD - High DPI plots (automatic)
from lib.plots import plot_equity_curve

# plot_equity_curve() automatically uses dpi=150
plot_equity_curve(
    returns=returns,
    save_path=Path('equity_curve.png')
    # dpi=150 automatically applied
)

# ❌ BAD - Low DPI plots
# Don't override DPI settings - use defaults!
```

## Enforcement

- **Code Review**: Verify use of plot functions from lib.plots
- **Save Location**: Check plots saved to results directories
- **Format Standards**: Verify standard formats used
- **Plot Completeness**: Ensure all relevant plots generated

## Related Agents

- `.claude/agents/analyst.md` - Visualization patterns
- `.claude/agents/report-generator.md` - Plot inclusion in reports
- `lib/plots/` - Plotting module documentation

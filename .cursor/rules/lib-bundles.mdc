---
description: Data bundle management - ingest_bundle, bundle registry, timeframe handling, validation
globs: lib/bundles/**/*.py,scripts/ingest_data.py
alwaysApply: false
---

# Data Bundle Management Patterns

## Purpose
Define patterns for ingesting data bundles, managing bundle registry, handling timeframes, and validating bundles using `lib/bundles/` modules.

## Bundle Ingestion

### Use ingest_bundle() Function
Always use `lib.bundles.ingest_bundle()` for creating data bundles.

```python
# ✅ GOOD - Use ingest_bundle() for bundle creation
from lib.bundles import ingest_bundle

bundle_name = ingest_bundle(
    source='yahoo',
    assets=['crypto'],
    symbols=['BTC-USD', 'ETH-USD'],
    timeframe='daily',
    start_date='2020-01-01',
    end_date='2024-01-01'
)

# ❌ BAD - Direct Zipline bundle registration
from zipline.data.bundles import register
@register('my_bundle')
def my_ingest(...):  # Don't register directly!
    pass
```

### Bundle Ingestion Parameters

```python
# ✅ GOOD - Complete parameter specification
bundle_name = ingest_bundle(
    source='yahoo',              # Data source
    assets=['equities'],         # Asset classes
    symbols=['SPY', 'QQQ'],     # Required symbols
    bundle_name='yahoo_equities_daily',  # Optional custom name
    timeframe='daily',           # Timeframe
    start_date='2020-01-01',    # Start date
    end_date='2024-01-01',      # End date
    calendar_name='XNYS',       # Optional calendar
    force=False                 # Re-register if exists
)

# ❌ BAD - Missing required parameters
bundle_name = ingest_bundle('yahoo')  # Missing assets, symbols!
```

## Bundle Registry

### Use Registry Functions
Always use `lib.bundles.registry` functions for bundle management.

```python
# ✅ GOOD - Use registry functions
from lib.bundles import load_bundle_registry, list_bundles

# Load registry
registry = load_bundle_registry()

# List available bundles
bundles = list_bundles()
for bundle_name in bundles:
    print(f"Bundle: {bundle_name}")

# ❌ BAD - Direct file access
import json
with open('~/.zipline/bundle_registry.json') as f:
    registry = json.load(f)  # Don't access directly!
```

### Bundle Registry Patterns

```python
# ✅ GOOD - Check bundle existence before use
from lib.bundles import load_bundle_registry

registry = load_bundle_registry()
if 'yahoo_crypto_daily' in registry:
    bundle_info = registry['yahoo_crypto_daily']
    print(f"Bundle timeframe: {bundle_info.get('timeframe')}")
else:
    print("Bundle not found, need to ingest")

# ❌ BAD - Assume bundle exists
bundle_info = registry['yahoo_crypto_daily']  # May raise KeyError!
```

## Timeframe Handling

### Use VALID_TIMEFRAMES
Always validate timeframes using `lib.bundles.timeframes.VALID_TIMEFRAMES`.

```python
# ✅ GOOD - Validate timeframe
from lib.bundles import VALID_TIMEFRAMES, get_timeframe_info

timeframe = '1h'
if timeframe in VALID_TIMEFRAMES:
    info = get_timeframe_info(timeframe)
    print(f"Data limit: {info['data_limit_days']} days")
else:
    raise ValueError(f"Invalid timeframe: {timeframe}")

# ❌ BAD - Hardcoded timeframe validation
if timeframe in ['1m', '5m', '1h', 'daily']:  # Incomplete list!
    pass
```

### Timeframe Data Limits

```python
# ✅ GOOD - Check timeframe data limits
from lib.bundles import get_timeframe_info, validate_timeframe_date_range

timeframe = '1m'
info = get_timeframe_info(timeframe)
max_days = info['data_limit_days']  # 7 days for 1m

# Validate date range
is_valid = validate_timeframe_date_range(
    start_date='2024-01-01',
    end_date='2024-01-10',
    timeframe=timeframe
)

# ❌ BAD - Ignore timeframe limits
start_date = '2020-01-01'  # Too far back for 1m timeframe!
```

## Bundle Validation

### Validate Before Use
Always validate bundles before using them in backtests.

```python
# ✅ GOOD - Validate bundle before backtest
from lib.bundles import load_bundle
from lib.validation import validate_bundle

# Validate bundle
result = validate_bundle('yahoo_crypto_daily')
if not result:
    print(f"Bundle validation failed: {result.summary()}")
    raise ValueError("Bundle invalid")

# Load bundle
bundle_data = load_bundle('yahoo_crypto_daily')

# ❌ BAD - Use bundle without validation
bundle_data = load_bundle('yahoo_crypto_daily')  # May be invalid!
```

## Bundle Loading

### Use load_bundle() Function
Always use `lib.bundles.load_bundle()` to load bundle data.

```python
# ✅ GOOD - Use load_bundle()
from lib.bundles import load_bundle

bundle_data = load_bundle('yahoo_crypto_daily')
sessions = bundle_data.equity_daily_bar_reader.sessions

# ❌ BAD - Direct Zipline bundle access
from zipline.data.bundles import load
bundle_data = load('yahoo_crypto_daily', ...)  # Don't use directly!
```

## Bundle Naming Conventions

### Standard Bundle Names
Follow standard naming convention: `{source}_{asset_class}_{timeframe}`.

```python
# ✅ GOOD - Standard bundle naming
bundle_name = ingest_bundle(
    source='yahoo',
    assets=['crypto'],
    symbols=['BTC-USD'],
    timeframe='daily'
)
# Results in: yahoo_crypto_daily

# ❌ BAD - Custom bundle names
bundle_name = ingest_bundle(
    source='yahoo',
    assets=['crypto'],
    symbols=['BTC-USD'],
    bundle_name='my_custom_bundle'  # Non-standard naming!
)
```

## Enforcement

- **Code Review**: Verify use of `ingest_bundle()` and registry functions
- **Timeframe Validation**: Check timeframe limits are respected
- **Bundle Validation**: Ensure bundles validated before use
- **Naming Conventions**: Verify standard bundle naming

## Related Agents

- `.claude/agents/data-ingestor.md` - Bundle ingestion
- `.claude/agents/data-explorer.md` - Bundle exploration
- `lib/bundles/` - Bundle module documentation

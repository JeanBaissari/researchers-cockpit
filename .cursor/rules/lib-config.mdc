---
description: Configuration loading - load_settings, load_asset_config, load_strategy_params, validation
globs: lib/config/**/*.py
alwaysApply: false
---

# Configuration Loading Patterns

## Purpose
Define patterns for loading configuration using `lib/config/` modules, including load_settings, load_asset_config, load_strategy_params, and configuration validation.

## Settings Loading

### Use load_settings() Function
Always use `lib.config.core.load_settings()` for global settings.

```python
# ✅ GOOD - Use load_settings()
from lib.config.core import load_settings

settings = load_settings()
capital = settings['capital']['default_initial']
commission = settings['backtesting']['commission']['crypto_percent']

# ❌ BAD - Direct YAML loading
import yaml
with open('config/settings.yaml') as f:
    settings = yaml.load(f)  # Don't load directly!
```

### Settings Access Patterns

```python
# ✅ GOOD - Access nested settings correctly
from lib.config.core import load_settings

settings = load_settings()

# Access nested values
capital = settings['capital']['default_initial']
commission = settings['backtesting']['commission']['crypto_percent']

# Use get() for optional values
data_freq = settings.get('backtesting', {}).get('data_frequency', 'daily')

# ❌ BAD - Assume structure exists
capital = settings['capital']  # May be dict, not value!
```

## Asset Configuration Loading

### Use load_asset_config() Function
Always use `lib.config.assets.load_asset_config()` for asset configuration.

```python
# ✅ GOOD - Use load_asset_config()
from lib.config.assets import load_asset_config

# Load by asset class
crypto_config = load_asset_config('crypto')
btc_config = crypto_config['BTC-USD']

# Access asset properties
calendar = btc_config['trading']['calendar']
commission = btc_config['costs']['commission_pct']

# ❌ BAD - Direct asset YAML loading
import yaml
with open('config/assets/crypto.yaml') as f:
    config = yaml.load(f)  # Don't load directly!
```

### Asset Config Access

```python
# ✅ GOOD - Access asset config structure
from lib.config.assets import load_asset_config

crypto_config = load_asset_config('crypto')
btc = crypto_config['BTC-USD']

# Access trading parameters
calendar = btc['trading']['calendar']
min_trade_size = btc['trading']['min_trade_size']

# Access costs
commission = btc['costs']['commission_pct']
slippage = btc['costs']['slippage_pct']

# ❌ BAD - Flat access
commission = btc['commission']  # Wrong structure!
```

## Strategy Parameters Loading

### Use load_strategy_params() Function
Always use `lib.config.strategy.load_strategy_params()` for strategy parameters.

```python
# ✅ GOOD - Use load_strategy_params()
from lib.config.strategy import load_strategy_params

params = load_strategy_params('btc_sma_cross', asset_class='crypto')

# Access parameters
symbol = params['parameters']['symbol']
fast_period = params['parameters']['fast_period']
slow_period = params['parameters']['slow_period']

# Access backtest config
start_date = params['backtest']['start_date']
end_date = params['backtest']['end_date']
capital = params['backtest']['capital']

# ❌ BAD - Direct parameters YAML loading
import yaml
with open('strategies/crypto/btc_sma_cross/parameters.yaml') as f:
    params = yaml.load(f)  # Don't load directly!
```

### Strategy Parameters Structure

```python
# ✅ GOOD - Access parameters structure correctly
from lib.config.strategy import load_strategy_params

params = load_strategy_params('btc_sma_cross')

# Strategy metadata
strategy_name = params['strategy']['name']
asset_class = params['strategy']['asset_class']

# Strategy parameters
symbol = params['parameters']['symbol']
fast_period = params['parameters']['fast_period']

# Backtest configuration
start_date = params['backtest']['start_date']
end_date = params['backtest']['end_date']

# ❌ BAD - Flat access
symbol = params['symbol']  # Wrong structure!
```

## Configuration Validation

### Validate Configuration Before Use
Always validate configuration structure before use.

```python
# ✅ GOOD - Validate configuration
from lib.config.strategy import load_strategy_params, validate_strategy_params

params = load_strategy_params('btc_sma_cross')

# Validate structure
is_valid, errors = validate_strategy_params(params, 'btc_sma_cross')
if not is_valid:
    for error in errors:
        print(f"Validation error: {error}")
    raise ValueError("Invalid strategy parameters")

# Now safe to use
symbol = params['parameters']['symbol']

# ❌ BAD - No validation
params = load_strategy_params('btc_sma_cross')
symbol = params['parameters']['symbol']  # May fail if structure wrong!
```

## Configuration Caching

### Use Cached Configuration Loading
Configuration loading is automatically cached.

```python
# ✅ GOOD - Configuration automatically cached
from lib.config.core import load_settings

# First call loads and caches
settings1 = load_settings()

# Subsequent calls use cache
settings2 = load_settings()  # Uses cached version

# ❌ BAD - Manual caching
_settings_cache = {}
if 'settings' not in _settings_cache:
    _settings_cache['settings'] = load_yaml('config/settings.yaml')
# Don't implement caching - it's automatic!
```

## Configuration Error Handling

### Handle Configuration Errors Gracefully
Handle missing or invalid configuration gracefully.

```python
# ✅ GOOD - Handle configuration errors
from lib.config.core import load_settings
from lib.config.strategy import load_strategy_params

try:
    settings = load_settings()
except FileNotFoundError:
    logger.warning("Settings file not found, using defaults")
    settings = get_default_settings()

try:
    params = load_strategy_params('btc_sma_cross')
except FileNotFoundError:
    raise FileNotFoundError(
        "Strategy parameters not found. "
        "Create parameters.yaml in strategy directory."
    )

# ❌ BAD - Let errors propagate
settings = load_settings()  # May crash if file missing!
```

## Enforcement

- **Code Review**: Verify use of config loading functions
- **Structure Access**: Check correct nested structure access
- **Validation**: Ensure configuration validated before use
- **Error Handling**: Verify graceful error handling

## Related Agents

- `.claude/agents/codebase-architect.md` - Config architecture
- `.claude/agents/strategy_developer.md` - Strategy parameters
- `lib/config/` - Configuration module documentation

# v1.0.9 Changes Applied
## Files Created/Modified During Pipeline Validation

**Date:** 2026-01-15
**Session Duration:** ~4 hours
**Total Issues Fixed:** 10

---

## Files Modified

### 1. `lib/bundles/api.py`
**Lines Changed:** 139-149
**Issue Fixed:** #2 - CSV data incorrectly limited by Yahoo API constraints

**Before:**
```python
if start_date is None:
    if tf_info['data_limit_days']:
        earliest = datetime.now().date() - timedelta(days=tf_info['data_limit_days'])
        start_date = earliest.isoformat()
    else:
        start_date = '2020-01-01'
```

**After:**
```python
if start_date is None:
    # CSV sources have no API limits - use full available data
    if source == 'csv':
        start_date = '2020-01-01'  # Default for CSV
    elif tf_info['data_limit_days']:
        # For API-based sources with limited timeframes
        earliest = datetime.now().date() - timedelta(days=tf_info['data_limit_days'])
        start_date = earliest.isoformat()
    else:
        start_date = '2020-01-01'
```

---

### 2. `scripts/ingest_data.py`
**Lines Changed:** 45-60, 150-158
**Issues Fixed:** #1 (bundle naming), #3 (misleading display message)

**Change 1 - Bundle Naming (Lines 45-60):**
```python
# Before
if custom_name:
    return f"{custom_name}_{timeframe}"
return f"{source}_{assets}_{timeframe}"

# After
if custom_name:
    # Avoid duplicating timeframe if already present
    if custom_name.endswith(f"_{timeframe}"):
        return custom_name
    return f"{custom_name}_{timeframe}"
return f"{source}_{assets}_{timeframe}"
```

**Change 2 - Display Message (Lines 150-158):**
```python
# Before
limit = TIMEFRAME_DATA_LIMITS.get(current_timeframe)
limit_info = f" ({limit} days max)" if limit else " (unlimited)"

# After
if source != 'csv':
    limit = TIMEFRAME_DATA_LIMITS.get(current_timeframe)
    limit_info = f" ({limit} days max)" if limit else " (unlimited)"
else:
    limit_info = ""  # CSV has no limits
```

---

### 3. `lib/bundles/csv_bundle.py`
**Lines Changed:** 433, 475-477, 514
**Issues Fixed:** #7 (exchange calendar hardcoded), #8 (missing gap filling)

**Change 1 - Exchange Calendar (Lines 433, 514):**
```python
# Before (both locations)
'exchange': 'CSV',

# After
'exchange': closure_calendar_name,  # Uses 'FOREX', 'CRYPTO', etc.
```

**Change 2 - Gap Filling in Aggregation Path (Lines 475-477):**
```python
# ADDED after calendar session filtering
if 'FOREX' in closure_calendar_name.upper() or 'CRYPTO' in closure_calendar_name.upper():
    daily_df = apply_gap_filling(daily_df, calendar_obj, closure_calendar_name, show_progress, sid)
    if daily_df.empty:
        continue
```

---

### 4. `lib/bundles/yahoo_bundle.py`
**Lines Changed:** 362-364
**Issue Fixed:** #8 (missing gap filling)

**Change - Gap Filling in Aggregation Path (Lines 362-364):**
```python
# ADDED after calendar session filtering
if 'FOREX' in closure_calendar_name.upper() or 'CRYPTO' in closure_calendar_name.upper():
    daily_df = apply_gap_filling(daily_df, calendar_obj, closure_calendar_name, show_progress, sid)
    if daily_df.empty:
        continue
```

---

### 5. `strategies/forex/breakout_intraday/strategy.py`
**Line Changed:** 406
**Issue Fixed:** #9 (dynamic pip value for multi-currency)

**Before:**
```python
pip_value = 0.0001  # TODO: Make this dynamic based on asset
```

**After:**
```python
pip_value = 0.01 if 'JPY' in context.asset.symbol else 0.0001
```

---

### 6. `strategies/forex/breakout_intraday/parameters.yaml`
**Lines Changed:** 108, 118
**Issues Fixed:** Bundle name updates, warmup days validation

**Change 1 - Bundle Name (Line 108):**
```yaml
# Before
bundle: csv_eurusd_1h_1h_1h

# After
bundle: csv_eurusd_1m  # Matches strategy's 1-minute data requirements
```

**Change 2 - Warmup Days (Line 118):**
```yaml
# Before
warmup_days: null

# After
warmup_days: 30
```

---

### 7. `lib/backtest/runner.py`
**Line Changed:** 64
**Issue Fixed:** Import error for bundle registry

**Before:**
```python
from ..bundles import _load_bundle_registry
registry = _load_bundle_registry()
```

**After:**
```python
from ..bundles import load_bundle_registry
registry = load_bundle_registry()
```

---

## Files Created

### 1. `lib/utils.py` ✨ NEW
**Size:** ~180 lines
**Issue Fixed:** #4 (missing lib/utils.py module)

**Purpose:** Core utilities for project root detection, path resolution, YAML operations, and re-exports from lib.data

**Key Functions:**
- `get_project_root()` - Find project root by marker files
- `get_strategy_path()` - Resolve strategy directory
- `load_yaml()`, `save_yaml()` - YAML file operations
- `ensure_dir()` - Directory creation with parents
- `normalize_to_utc()` - Date normalization
- `timestamp_dir()` - Generate timestamped directory names
- `update_symlink()` - Symlink management
- `check_and_fix_symlinks()` - Broken symlink cleanup

---

### 2. `lib/extension.py` ✨ NEW
**Size:** ~40 lines
**Issue Fixed:** #5 (missing lib/extension.py compatibility layer)

**Purpose:** Backward compatibility wrapper for code importing from `lib.extension`

**Content:** Re-exports all calendar functions from `lib.calendars` with deprecation warning

---

### 3. `~/.zipline/extension.py` ✨ RECREATED
**Size:** ~40 lines
**Issue Fixed:** #6 (__file__ used in exec() context)

**Purpose:** Zipline extension file for custom calendar registration

**Key Change:** Uses `os.path.expanduser('~/.zipline')` instead of `__file__` for path resolution (exec-compatible)

---

### 4. `docs/v1.0.9_pipeline_validation_report.md` ✨ NEW
**Size:** ~500 lines
**Purpose:** Comprehensive report documenting all issues found and fixes applied

**Sections:**
- Executive Summary
- Critical Issues Discovered & Resolved (all 10 issues)
- Architectural Observations
- Lessons Learned
- Remaining Tasks

---

### 5. `docs/CSV_INGESTION_BEST_PRACTICES.md` ✨ NEW
**Size:** ~400 lines
**Purpose:** Best practices guide for CSV data ingestion

**Sections:**
- Bundle Naming Convention
- Data Frequency Matching
- Ingestion Time Estimates
- Calendar Selection
- Common Pitfalls
- Recommended Workflow
- Troubleshooting

---

## Summary Statistics

### Code Changes
- **Files Modified:** 7
- **Files Created:** 5
- **Total Lines Changed:** ~150
- **Total Lines Added:** ~620

### Issues Resolved
- **Critical:** 4 (issues #2, #4, #6, #7)
- **High:** 3 (issues #1, #7, #8)
- **Medium:** 3 (issues #3, #5, #9)
- **Total:** 10 issues

### Testing Status
- ✅ All imports verified working
- ✅ Module interdependencies tested
- ⏳ Bundle ingestion in progress (EURUSD 1m)
- ⏳ Backtest execution pending

---

## Git Commit Recommendation

When committing these changes, use the following structure:

```bash
git add lib/utils.py lib/extension.py ~/.zipline/extension.py
git add lib/bundles/api.py lib/bundles/csv_bundle.py lib/bundles/yahoo_bundle.py
git add lib/backtest/runner.py
git add scripts/ingest_data.py
git add strategies/forex/breakout_intraday/strategy.py
git add strategies/forex/breakout_intraday/parameters.yaml
git add docs/v1.0.9_pipeline_validation_report.md
git add docs/CSV_INGESTION_BEST_PRACTICES.md

git commit -m "fix: resolve 10 critical pipeline issues discovered during v1.0.9 validation

- Fix bundle naming convention to prevent duplicate timeframe suffixes
- Remove Yahoo API limits from CSV source ingestion (critical data loss bug)
- Fix exchange calendar hardcoded as 'CSV' instead of actual calendar
- Add missing gap filling in intraday aggregation path (Good Friday fix)
- Create lib/utils.py with essential utilities (modular refactoring fix)
- Create lib/extension.py compatibility wrapper for backward compatibility
- Fix .zipline/extension.py to work in exec() context (no __file__)
- Add dynamic pip value calculation for JPY pairs
- Update strategy to use correct 1m data bundle
- Add comprehensive documentation (validation report, best practices)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Rollback Instructions

If these changes cause issues:

```bash
# Revert code changes
git revert HEAD

# Remove created files
rm lib/utils.py lib/extension.py
rm ~/.zipline/extension.py
rm docs/v1.0.9_pipeline_validation_report.md
rm docs/CSV_INGESTION_BEST_PRACTICES.md

# Clean up ingested bundles
rm -rf ~/.zipline/data/csv_*_1m/
```

---

## Next Steps After This Session

1. Complete EURUSD 1m ingestion (in progress)
2. Ingest NZDJPY 1m bundle
3. Run successful backtests for both pairs
4. Clean up old bundles from registry
5. Add regression tests for discovered edge cases
6. Consider adding pre-flight checks:
   - Strategy frequency vs bundle frequency validation
   - Better progress indicators for long ingestions
   - Automated bundle cleanup utilities

---

**Document Generated:** 2026-01-15 04:52 UTC-3
**Session ID:** Pipeline Validation v1.0.9
**Files Modified/Created:** 12
**Total Impact:** ~770 lines of code/documentation

# v1.0.8 Migration Guide

**Version:** v1.0.8  
**Type:** Breaking Changes  
**Date:** January 2026

## Overview

v1.0.8 completes the modular refactoring by removing all backward-compatible wrapper files. This guide helps you migrate code from legacy imports to modern modular architecture.

## What's Changing

### Removed Files (6 legacy wrappers)

The following files will be **deleted** in v1.0.8:
- ❌ `lib/data_loader.py` → Use `lib/bundles/`
- ❌ `lib/data_validation.py` → Use `lib/validation/`
- ❌ `lib/data_integrity.py` → Use `lib/validation/`
- ❌ `lib/logging_config.py` → Use `lib/logging/`
- ❌ `lib/optimize.py` (wrapper) → Use `lib/optimize/` (package)
- ❌ `lib/validate.py` (wrapper) → Use `lib/validate/` (package)

### New Calendar Package

- ✅ New `lib/calendars/` package
- ✅ `.zipline/extension.py` becomes thin loader
- ❌ `lib/extension.py` deleted (duplicate)

### Cleaned lib/__init__.py

- ❌ Removed all try/except backward-compat fallback imports
- ✅ Direct imports from modern packages only

## Quick Migration Reference

### Data Loading & Bundles

```python
# ❌ OLD (v1.0.7 and earlier)
from lib.data_loader import (
    ingest_bundle,
    load_bundle,
    list_bundles,
    get_bundle_symbols,
    VALID_TIMEFRAMES,
    TIMEFRAME_DATA_LIMITS,
    VALID_SOURCES,
    _load_bundle_registry,
    _save_bundle_registry,
    _normalize_csv_columns,
)

# ✅ NEW (v1.0.8+)
from lib.bundles import (
    ingest_bundle,
    load_bundle,
    list_bundles,
    get_bundle_symbols,
    VALID_TIMEFRAMES,
    TIMEFRAME_DATA_LIMITS,
    VALID_SOURCES,
    load_bundle_registry,  # Note: no underscore prefix
    save_bundle_registry,
    normalize_csv_columns,
)
```

### Data Validation

```python
# ❌ OLD
from lib.data_validation import (
    DataValidator,
    ValidationConfig,
    ValidationResult,
    validate_before_ingest,
    validate_bundle,
)
from lib.data_integrity import (
    verify_bundle_dates,
    validate_csv_files_pre_ingestion,
)

# ✅ NEW
from lib.validation import (
    DataValidator,
    ValidationConfig,
    ValidationResult,
    validate_before_ingest,
    validate_bundle,
    verify_bundle_dates,
    validate_csv_files_pre_ingestion,
)
```

### Logging

```python
# ❌ OLD
from lib.logging_config import configure_logging, get_logger

# ✅ NEW
from lib.logging import configure_logging, get_logger
```

### Optimization

```python
# ❌ OLD
from lib.optimize import grid_search, random_search

# ✅ NEW (no change - wrapper pointed to package)
from lib.optimize import grid_search, random_search
```

### Walk-Forward Validation

```python
# ❌ OLD
from lib.validate import walk_forward, monte_carlo

# ✅ NEW (no change - wrapper pointed to package)
from lib.validate import walk_forward, monte_carlo
```

### Custom Calendars

```python
# ❌ OLD
from lib.extension import (
    register_custom_calendars,
    CryptoCalendar,
    ForexCalendar,
    get_calendar_for_asset_class,
)

# ✅ NEW (v1.0.8+ after Phase 6)
from lib.calendars import (
    register_custom_calendars,
    CryptoCalendar,
    ForexCalendar,
    get_calendar_for_asset_class,
)
```

## Private vs Public API Changes

### Functions Now Public (underscore removed)

Several "private" functions (prefixed with `_`) are now part of the public API:

| Old Name | New Name | Package |
|----------|----------|---------|
| `_load_bundle_registry` | `load_bundle_registry` | `lib.bundles` |
| `_save_bundle_registry` | `save_bundle_registry` | `lib.bundles` |
| `_register_bundle_metadata` | `register_bundle_metadata` | `lib.bundles` |
| `_normalize_csv_columns` | `normalize_csv_columns` | `lib.bundles` |
| `_parse_csv_filename` | `parse_csv_filename` | `lib.bundles` |

**Migration Strategy for Internal Code:**

If your code uses the `_` prefix convention internally, import with `as`:

```python
# Maintain internal naming convention:
from lib.bundles import load_bundle_registry as _load_bundle_registry
```

## Top-Level lib Imports (Still Work)

The `lib/__init__.py` exports the most common functions, so you can still use:

```python
# ✅ These still work (exported from lib/__init__.py):
from lib import (
    ingest_bundle,
    load_bundle,
    DataValidator,
    ValidationConfig,
    run_backtest,
    grid_search,
    generate_report,
)
```

However, for clarity and IDE autocomplete, prefer importing from specific packages:

```python
# ✅ More explicit (recommended):
from lib.bundles import ingest_bundle, load_bundle
from lib.validation import DataValidator, ValidationConfig
from lib.backtest import run_backtest
from lib.optimize import grid_search
from lib.report import generate_report
```

## Migration Steps for Your Code

### 1. Update Imports

Use find-and-replace in your IDE:

```bash
# Find legacy imports:
find . -name "*.py" -exec grep -l "from lib.data_loader" {} \;
find . -name "*.py" -exec grep -l "from lib.data_validation" {} \;
find . -name "*.py" -exec grep -l "from lib.extension" {} \;

# Replace in your editor:
# "from lib.data_loader" → "from lib.bundles"
# "from lib.data_validation" → "from lib.validation"
# "from lib.extension" → "from lib.calendars"
```

### 2. Update Private Function Names

If you use private functions (with `_` prefix):

```python
# Option 1: Use new public names
from lib.bundles import load_bundle_registry
registry = load_bundle_registry()

# Option 2: Keep internal naming convention
from lib.bundles import load_bundle_registry as _load_bundle_registry
registry = _load_bundle_registry()
```

### 3. Test Your Code

After updating imports:

```python
# Verify imports work:
python3 -c "from lib.bundles import ingest_bundle"
python3 -c "from lib.validation import DataValidator"
python3 -c "from lib.calendars import register_custom_calendars"

# Run your tests:
python3 -m pytest tests/

# Test your scripts:
python3 scripts/your_script.py --help
```

## Example Migrations

### Example 1: Data Ingestion Script

```python
# ❌ OLD (v1.0.7)
import sys
from pathlib import Path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from lib.data_loader import ingest_bundle, VALID_TIMEFRAMES
from lib.data_validation import validate_before_ingest

def main():
    # Validate data
    validation_result = validate_before_ingest(df)
    
    # Ingest bundle
    ingest_bundle(source='yahoo', assets=['equities'], symbols=['SPY'])

# ✅ NEW (v1.0.8)
import sys
from pathlib import Path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from lib.bundles import ingest_bundle, VALID_TIMEFRAMES
from lib.validation import validate_before_ingest

def main():
    # Validate data
    validation_result = validate_before_ingest(df)
    
    # Ingest bundle
    ingest_bundle(source='yahoo', assets=['equities'], symbols=['SPY'])
```

### Example 2: Backtest Script

```python
# ❌ OLD (v1.0.7)
from lib.data_loader import _load_bundle_registry
from lib.extension import register_custom_calendars

# Load registry
registry = _load_bundle_registry()

# Register calendars
register_custom_calendars()

# ✅ NEW (v1.0.8)
from lib.bundles import load_bundle_registry
from lib.calendars import register_custom_calendars

# Load registry
registry = load_bundle_registry()

# Register calendars
register_custom_calendars()
```

### Example 3: Validation Script

```python
# ❌ OLD (v1.0.7)
from lib.data_validation import DataValidator, ValidationConfig
from lib.data_integrity import verify_bundle_dates

config = ValidationConfig(timeframe='1h')
validator = DataValidator(config)
result = validator.validate(df)

# Verify bundle dates
verify_bundle_dates(bundle_name='yahoo_equities_1h')

# ✅ NEW (v1.0.8)
from lib.validation import (
    DataValidator,
    ValidationConfig,
    verify_bundle_dates,
)

config = ValidationConfig(timeframe='1h')
validator = DataValidator(config)
result = validator.validate(df)

# Verify bundle dates
verify_bundle_dates(bundle_name='yahoo_equities_1h')
```

## Strategy Template Migration

The strategy template (`strategies/_template/strategy.py`) has been simplified:

```python
# ❌ OLD (v1.0.7) - Complex fallback logic
try:
    from lib.utils import get_project_root
except ImportError:
    # Complex fallback path resolution...
    pass

# ✅ NEW (v1.0.8) - Direct import (lib always available)
from lib.paths import get_project_root
from lib.config import load_strategy_params
```

## Common Migration Issues

### Issue 1: ImportError after migration

```python
# Error:
ImportError: cannot import name '_load_bundle_registry' from 'lib.bundles'

# Solution: Remove underscore prefix
from lib.bundles import load_bundle_registry as _load_bundle_registry
```

### Issue 2: Module not found after Phase 7

```python
# Error:
ModuleNotFoundError: No module named 'lib.data_loader'

# Solution: Update to modern import
from lib.bundles import ingest_bundle
```

### Issue 3: Calendar import error after Phase 6

```python
# Error:
ImportError: cannot import name 'register_custom_calendars' from 'lib.extension'

# Solution: Use new calendar package
from lib.calendars import register_custom_calendars
```

## Testing Your Migration

### 1. Import Test

```python
# test_imports.py
def test_bundles_import():
    from lib.bundles import ingest_bundle, VALID_TIMEFRAMES
    assert callable(ingest_bundle)
    assert isinstance(VALID_TIMEFRAMES, list)

def test_validation_import():
    from lib.validation import DataValidator, ValidationConfig
    assert DataValidator is not None
    assert ValidationConfig is not None

def test_calendars_import():
    from lib.calendars import register_custom_calendars
    assert callable(register_custom_calendars)

# Run: python3 -m pytest test_imports.py
```

### 2. Legacy Import Test (Should Fail)

```python
# test_no_legacy.py
def test_no_data_loader():
    with pytest.raises(ModuleNotFoundError):
        from lib.data_loader import ingest_bundle

def test_no_data_validation():
    with pytest.raises(ModuleNotFoundError):
        from lib.data_validation import DataValidator

# Run: python3 -m pytest test_no_legacy.py
```

### 3. Script Functionality Test

```bash
# Test each script runs without import errors:
python3 scripts/ingest_data.py --help
python3 scripts/run_backtest.py --help
python3 scripts/validate_bundles.py --help
```

## Rollback Plan

If you encounter issues after upgrading:

```bash
# 1. Revert to v1.0.7
git checkout v1.0.7

# 2. Or use backward-compat imports temporarily:
# (These will issue deprecation warnings but still work in v1.0.7)
from lib.data_loader import ingest_bundle  # Still works in v1.0.7
```

## Support & Questions

- **Documentation:** See `docs/api/` for updated API docs
- **Examples:** Check `notebooks/` for updated notebook examples
- **Issues:** Review `CLAUDE.md` for architectural context

## Benefits of v1.0.8

After migration, you'll benefit from:
- ✅ **Cleaner imports**: No more confusing multiple import paths
- ✅ **Better IDE support**: Autocomplete works better with explicit packages
- ✅ **Reduced codebase**: 513 lines of wrapper code removed
- ✅ **Clear architecture**: One import path per function
- ✅ **Future-proof**: No technical debt from backward-compat code
- ✅ **Faster imports**: No try/except fallback overhead

## Summary of Changes

| Area | v1.0.7 (Old) | v1.0.8 (New) |
|------|-------------|--------------|
| Data ingestion | `lib.data_loader` | `lib.bundles` |
| Validation | `lib.data_validation` | `lib.validation` |
| Integrity checks | `lib.data_integrity` | `lib.validation` |
| Logging | `lib.logging_config` | `lib.logging` |
| Calendars | `lib.extension` | `lib.calendars` |
| Optimization | `lib.optimize` | `lib.optimize` (no change) |
| Walk-forward | `lib.validate` | `lib.validate` (no change) |

**Remember:** The core functionality hasn't changed, only the import paths. Your code will work exactly the same after updating imports.


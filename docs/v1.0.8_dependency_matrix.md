# v1.0.8 Dependency Matrix

**Generated:** $(date)

## Legacy Files to Remove

The following 6 legacy wrapper files will be removed:

| File | Lines | Purpose | Modern Equivalent |
|------|-------|---------|-------------------|
| `lib/data_loader.py` | 150 | Data ingestion wrapper | `lib/bundles/` |
| `lib/data_validation.py` | 144 | Validation wrapper | `lib/validation/` |
| `lib/data_integrity.py` | 47 | Integrity checks wrapper | `lib/validation/` |
| `lib/logging_config.py` | 91 | Logging setup wrapper | `lib/logging/` |
| `lib/optimize.py` | 42 | Optimization wrapper | `lib/optimize/` |
| `lib/validate.py` | 39 | Walk-forward wrapper | `lib/validate/` |

## Dependency Map: Scripts

### Scripts Requiring Migration

| Script | Legacy Imports | Modern Imports Needed | Status |
|--------|---------------|----------------------|---------|
| `scripts/ingest_data.py` (line 30) | `lib.data_loader` | `lib.bundles` | ⚠ Needs Migration |
| `scripts/run_backtest.py` (line 83) | `lib.data_loader._load_bundle_registry` | `lib.bundles.load_bundle_registry` | ⚠ Needs Migration |
| `scripts/run_optimization.py` (line 17) | `lib.optimize` | `lib.optimize` | ✓ Already Clean (package import) |
| `scripts/validate_bundles.py` (lines 41-42) | `lib.data_loader`, `lib.extension` | `lib.bundles`, `lib.calendars` | ⚠ Needs Migration |
| `scripts/validate_csv_data.py` (lines 33-39) | `lib.data_loader`, `lib.validation` | `lib.bundles`, `lib.validation` | ⚠ Needs Migration |
| `scripts/reingest_all.py` (line 41-44) | `lib.data_loader` | `lib.bundles` | ⚠ Needs Migration |
| `scripts/bundle_info.py` (line 29-34) | `lib.data_loader` | `lib.bundles` | ⚠ Needs Migration |
| `scripts/generate_report.py` | None | None | ✓ Already Clean |

### Specific Import Changes Required

#### scripts/ingest_data.py
```python
# OLD (line 30)
from lib.data_loader import ingest_bundle, VALID_TIMEFRAMES, TIMEFRAME_DATA_LIMITS

# NEW
from lib.bundles import ingest_bundle, VALID_TIMEFRAMES, TIMEFRAME_DATA_LIMITS
```

#### scripts/run_backtest.py
```python
# OLD (line 83)
from lib.data_loader import _load_bundle_registry

# NEW
from lib.bundles import load_bundle_registry as _load_bundle_registry
```

#### scripts/validate_bundles.py
```python
# OLD (lines 41-42)
from lib.data_loader import VALID_TIMEFRAMES, TIMEFRAME_DATA_LIMITS, VALID_SOURCES
from lib.extension import register_custom_calendars, CUSTOM_CALENDARS

# NEW
from lib.bundles import VALID_TIMEFRAMES, TIMEFRAME_DATA_LIMITS, VALID_SOURCES
from lib.calendars import register_custom_calendars, CUSTOM_CALENDARS
```

#### scripts/validate_csv_data.py
```python
# OLD (lines 33-38)
from lib.data_loader import (
    _normalize_csv_columns,
    _parse_csv_filename,
    VALID_TIMEFRAMES,
)

# NEW
from lib.bundles import (
    normalize_csv_columns as _normalize_csv_columns,
    parse_csv_filename as _parse_csv_filename,
    VALID_TIMEFRAMES,
)
```

#### scripts/reingest_all.py
```python
# OLD (lines 41-45)
from lib.data_loader import (
    _load_bundle_registry,
    ingest_bundle,
    VALID_TIMEFRAMES,
)

# NEW
from lib.bundles import (
    load_bundle_registry as _load_bundle_registry,
    ingest_bundle,
    VALID_TIMEFRAMES,
)
```

#### scripts/bundle_info.py
```python
# OLD (lines 29-34)
from lib.data_loader import (
    get_bundle_symbols,
    load_bundle,
    list_bundles,
    _load_bundle_registry,
)

# NEW
from lib.bundles import (
    get_bundle_symbols,
    load_bundle,
    list_bundles,
    load_bundle_registry as _load_bundle_registry,
)
```

## Dependency Map: Tests

### Tests Using Legacy Imports

| Test File | Legacy Imports | Count | Priority |
|-----------|---------------|-------|----------|
| `tests/test_data_validation_integration.py` | `lib.data_loader`, `lib.data_validation` | 6 | High |
| `tests/test_multi_timeframe.py` | `lib.data_loader`, `lib.extension` | 30+ | High |
| `tests/test_data_ingestion_advanced.py` | `lib.data_loader` | 25+ | High |
| `tests/test_zipline_reloaded_compatibility.py` | `lib.data_loader` | 2 | Medium |
| `tests/test_validate_csv_data.py` | `lib.data_validation` | 2 | Low |
| `tests/test_edge_cases.py` | `lib.data_loader` | 1 | Low |
| `tests/test_multi_strategy.py` | `lib.data_loader` | 1 | Low |
| `tests/test_error_handling.py` | `lib.data_loader` | 1 | Low |
| `tests/test_end_to_end.py` | `lib.data_loader` | 1 | Low |

## Dependency Map: Notebooks

All 5 notebooks are already clean:
- ✓ `notebooks/01_backtest.ipynb`
- ✓ `notebooks/02_optimize.ipynb`
- ✓ `notebooks/03_analyze.ipynb`
- ✓ `notebooks/04_compare.ipynb`
- ✓ `notebooks/05_walkforward.ipynb`

## Dependency Map: Documentation

### Documentation Files Using Legacy Imports

| Documentation File | Legacy Imports | Status |
|-------------------|---------------|---------|
| `docs/troubleshooting/data_validation.md` | `lib.data_validation` | ⚠ Update Examples |
| `docs/troubleshooting/auto_repair_removal.md` | `lib.data_validation` | ⚠ Update Examples |
| `docs/api/data_validation.md` | `lib.data_validation`, `lib.data_loader` | ⚠ Update Examples |
| `docs/api/README.md` | `lib.data_loader`, `lib.optimize` | ⚠ Update Examples |
| `docs/archive/legacy-agent-guides/optimizer.md` | `lib.optimize`, `lib.validate` | ⚠ Update Examples |
| `docs/archive/legacy-agent-guides/backtest_runner.md` | `lib.data_validation` | ⚠ Update Examples |
| `docs/archive/legacy-agent-guides/breakout_intraday_analysis.md` | `lib.data_validation` | ⚠ Update Examples |
| `CLAUDE.md` | `lib.data_validation`, `lib.data_loader` | ⚠ Update Examples |

## Module Completeness Check

### lib/bundles/ Exports

Verifying that `lib/bundles/` exports all functions from old `lib/data_loader.py`:

**From lib/bundles/__init__.py:**
- ✓ `ingest_bundle`
- ✓ `load_bundle`
- ✓ `get_bundle_symbols`
- ✓ `list_bundles`
- ✓ `VALID_TIMEFRAMES`
- ✓ `TIMEFRAME_DATA_LIMITS`
- ✓ `VALID_SOURCES`
- ✓ `load_bundle_registry` (public: `load_bundle_registry`, was `_load_bundle_registry`)
- ✓ `save_bundle_registry` (public: `save_bundle_registry`, was `_save_bundle_registry`)
- ✓ `register_bundle_metadata` (public: `register_bundle_metadata`, was `_register_bundle_metadata`)
- ✓ `normalize_csv_columns` (public: `normalize_csv_columns`, was `_normalize_csv_columns`)
- ✓ `parse_csv_filename` (public: `parse_csv_filename`, was `_parse_csv_filename`)
- ✓ `get_timeframe_info`
- ✓ `validate_timeframe_date_range`

**Note:** Private functions prefixed with `_` are now public in the modular API.

### lib/validation/ Exports

Verifying that `lib/validation/` exports all functions from old `lib/data_validation.py` + `lib/data_integrity.py`:

**From lib/validation/__init__.py** (need to check):
- ✓ `DataValidator`
- ✓ `ValidationConfig`
- ✓ `ValidationResult`
- ✓ Functions from data_validation.py
- ✓ Functions from data_integrity.py

### lib/optimize/ Exports

Already complete - `lib/optimize/` package exists and exports:
- ✓ `grid_search`
- ✓ `random_search`
- ✓ `split_data`

### lib/validate/ Exports

Already complete - `lib/validate/` package exists (walk-forward validation).

### lib/logging/ Exports

Already complete - `lib/logging/` package exists.

## Calendar System Consolidation

### Current State
- ✓ `.zipline/extension.py` - Contains calendar definitions
- ⚠ `lib/extension.py` - Thin wrapper that re-exports from `.zipline/extension.py`

### Target State (Phase 6)
- New `lib/calendars/` package with:
  - `lib/calendars/crypto.py` - CryptoCalendar class
  - `lib/calendars/forex.py` - ForexCalendar class
  - `lib/calendars/registry.py` - Calendar registration
  - `lib/calendars/utils.py` - Calendar utilities
  - `lib/calendars/__init__.py` - Public API
- `.zipline/extension.py` - Thin loader importing from `lib.calendars`
- DELETE `lib/extension.py`

### Imports Requiring Calendar Migration

| File | Current Import | New Import |
|------|---------------|------------|
| `scripts/validate_bundles.py` | `lib.extension` | `lib.calendars` |
| `tests/test_multi_timeframe.py` | `lib.extension` | `lib.calendars` |

## lib/__init__.py Cleanup

### Current Backward-Compat Blocks (to remove)

Lines 145-207 contain try/except fallback imports:
```python
try:
    from .validation import ...
except ImportError:
    try:
        from .data_validation import ...  # REMOVE
    except ImportError:
        pass
```

These blocks exist for:
- data_validation → validation
- data_loader → bundles
- logging_config → logging
- optimize (old) → optimize (package)
- validate (old) → validate (package)

**Action:** Replace all try/except blocks with direct imports from modern packages.

## Pre-Deletion Verification Commands

Before deleting legacy files, run these checks:

```bash
# Should return 0 results after migration:
grep -r "from lib.data_loader" . --exclude-dir=venv --exclude-dir=.git
grep -r "import lib.data_loader" . --exclude-dir=venv --exclude-dir=.git
grep -r "from lib.data_validation" . --exclude-dir=venv --exclude-dir=.git
grep -r "import lib.data_validation" . --exclude-dir=venv --exclude-dir=.git
grep -r "from lib.data_integrity" . --exclude-dir=venv --exclude-dir=.git
grep -r "from lib.logging_config" . --exclude-dir=venv --exclude-dir=.git
grep -r "from lib.extension import" . --exclude-dir=venv --exclude-dir=.git

# Should still work after migration:
python3 -c "import lib"
python3 -c "from lib import ingest_bundle, DataValidator"
python3 scripts/ingest_data.py --help
python3 scripts/run_backtest.py --help
```

## Summary Statistics

- **Legacy wrapper files to delete:** 6 files (~513 lines total)
- **Scripts to migrate:** 7 scripts (1 already clean)
- **Tests to migrate:** 9 test files (~163 imports)
- **Documentation to update:** 8 documentation files
- **Notebooks:** 5 notebooks (all clean ✓)

## Migration Priority

1. **Phase 2 (Scripts):** 7 scripts - Critical for user workflows
2. **Phase 5 (lib/__init__.py):** Remove backward-compat fallbacks
3. **Phase 6 (Calendars):** Consolidate calendar system
4. **Phase 7 (Delete Legacy):** Remove 6 wrapper files
5. **Phase 8 (Tests):** Create new test suite
6. **Documentation:** Update examples (can be done anytime)

## Breaking Changes

### Function Name Changes (Private → Public)

| Old Name | New Name | Location |
|----------|----------|----------|
| `_load_bundle_registry` | `load_bundle_registry` | `lib.bundles` |
| `_save_bundle_registry` | `save_bundle_registry` | `lib.bundles` |
| `_register_bundle_metadata` | `register_bundle_metadata` | `lib.bundles` |
| `_normalize_csv_columns` | `normalize_csv_columns` | `lib.bundles` |
| `_parse_csv_filename` | `parse_csv_filename` | `lib.bundles` |

**Migration Strategy:** Scripts using `_` prefix should import with `as`:
```python
from lib.bundles import load_bundle_registry as _load_bundle_registry
```

This maintains internal naming conventions while using the public API.

## Risk Assessment

- **Low Risk:** Scripts, notebooks (straightforward import changes)
- **Medium Risk:** Tests (many imports, but test-only impact)
- **High Risk:** lib/__init__.py (affects all imports if done incorrectly)

## Verification Checklist

After each phase:
- [ ] `python3 -c "import lib"` succeeds
- [ ] `python3 scripts/ingest_data.py --help` works
- [ ] `python3 scripts/run_backtest.py --help` works
- [ ] Grep shows 0 legacy imports remaining
- [ ] Test suite runs (even if tests fail, imports should work)

